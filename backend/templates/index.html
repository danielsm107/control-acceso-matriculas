{% extends "base.html" %}
{% block content %}
<div class="container py-5">

  <form action="{{ url_for('subir_imagen_perfil') }}" method="POST" enctype="multipart/form-data">
    <div class="d-flex align-items-center gap-3 mb-4">
      <img src="{{ url_for('static', filename='fotos_perfil/' + current_user.foto if current_user.foto else 'icons/profile-user.png') }}"
           class="rounded-circle border border-info" width="100" height="100" alt="Perfil">
      
      <div>
        <input type="file" name="imagen" accept="image/*" class="form-control form-control-sm" required>
        <button type="submit" class="btn btn-outline-info btn-sm mt-2">Cambiar imagen</button>
      </div>
    </div>
  </form>

  <div class="text-white">
    <h4 class="mb-3">Mis Matrículas Registradas</h4>
    <table class="table-modern w-100">
      <thead>
        <tr>
          <th onclick="sortTable(0, this)">MATRÍCULA <span class="sort-icon">⇅</span></th>
          <th onclick="sortTable(1, this)">ESTADO <span class="sort-icon">⇅</span></th>
        </tr>
      </thead>
      <tbody>
        {% for matricula, estado in matriculas %}
        <tr>
          <td>{{ matricula }}</td>
          <td>
            <span class="status-badge 
              {% if estado == 'autorizada' %}authorized
              {% elif estado == 'pendiente' %}pending
              {% else %}denied{% endif %}">
              {{ estado|capitalize }}
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
let lastSortedColumn = null;
let lastSortDirection = 'asc';

function sortTable(colIndex, thElement) {
  const table = document.querySelector(".table-modern tbody");
  const rows = Array.from(table.rows);
  const isNumeric = !isNaN(rows[0].cells[colIndex].innerText.trim());

  const shouldReverse = lastSortedColumn === colIndex && lastSortDirection === 'asc';
  lastSortedColumn = colIndex;
  lastSortDirection = shouldReverse ? 'desc' : 'asc';

  const sortedRows = rows.sort((a, b) => {
    const aText = a.cells[colIndex].innerText.trim().toLowerCase();
    const bText = b.cells[colIndex].innerText.trim().toLowerCase();
    return shouldReverse ? bText.localeCompare(aText) : aText.localeCompare(bText);
  });

  table.innerHTML = '';
  sortedRows.forEach(row => table.appendChild(row));

  document.querySelectorAll(".sort-icon").forEach(i => i.textContent = '⇅');
  thElement.querySelector(".sort-icon").textContent = shouldReverse ? '↓' : '↑';
}
</script>
{% endblock %}
