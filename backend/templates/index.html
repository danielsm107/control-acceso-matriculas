{% extends "base.html" %}
{% block content %}
<div class="container py-5">

  <!-- Cabecera de usuario -->
  {% if current_user.rol != 'admin' %}
  <div class="d-flex align-items-center gap-4 mb-4">
    <img src="{{ url_for('static', filename='fotos_perfil/' + current_user.foto) if current_user.foto else url_for('static', filename='icons/profile-user.png') }}"
         class="rounded-circle border border-info" width="90" height="90" alt="Foto de perfil">
    <div class="text-white">
      <h2 class="mb-0">{{ current_user.nombre }}</h2>
      <small class="text-muted">{{ current_user.email }}</small>
    </div>
  </div>
  {% endif %}

  <!-- Tarjetas resumen -->
  <div class="row text-white mb-4">
    <div class="col-md-4">
      <div class="card bg-dark border-primary shadow-sm p-3">
        <h6 class="text-uppercase text-muted">Total Matrículas</h6>
        <h3>{{ matriculas|length }}</h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-dark border-success shadow-sm p-3">
        <h6 class="text-uppercase text-muted">Autorizadas</h6>
        <h3>{{ matriculas|selectattr('1', 'equalto', 'autorizada')|list|length }}</h3>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-dark border-danger shadow-sm p-3">
        <h6 class="text-uppercase text-muted">Denegadas</h6>
        <h3>{{ matriculas|selectattr('1', 'equalto', 'denegada')|list|length }}</h3>
      </div>
    </div>
  </div>

  <!-- Tabla de matrículas -->
  {% if current_user.rol != 'admin' %}
  <h4 class="text-white mb-3">Mis Matrículas Registradas</h4>
  <table class="table-modern w-100">
    <thead>
      <tr>
        <th onclick="sortTable(0, this)">Matrícula <span class="sort-icon">⇅</span></th>
        <th onclick="sortTable(1, this)">Estado <span class="sort-icon">⇅</span></th>
      </tr>
    </thead>
    <tbody>
      {% for matricula, estado in matriculas %}
      <tr>
        <td>{{ matricula }}</td>
        <td>
          <span class="status-badge 
            {% if estado == 'autorizada' %}authorized
            {% elif estado == 'pendiente' %}pending
            {% else %}denied{% endif %}">
            {{ estado|capitalize }}
          </span>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
  let lastSortedColumn = null;
  let lastSortDirection = 'asc';

  function sortTable(colIndex, thElement) {
    const table = document.querySelector(".table-modern tbody");
    const rows = Array.from(table.rows);

    const shouldReverse = lastSortedColumn === colIndex && lastSortDirection === 'asc';
    lastSortedColumn = colIndex;
    lastSortDirection = shouldReverse ? 'desc' : 'asc';

    const sortedRows = rows.sort((a, b) => {
      const aText = a.cells[colIndex].innerText.trim().toLowerCase();
      const bText = b.cells[colIndex].innerText.trim().toLowerCase();
      return shouldReverse ? bText.localeCompare(aText) : aText.localeCompare(bText);
    });

    table.innerHTML = '';
    sortedRows.forEach(row => table.appendChild(row));

    document.querySelectorAll(".sort-icon").forEach(i => i.textContent = '⇅');
    thElement.querySelector(".sort-icon").textContent = shouldReverse ? '↓' : '↑';
  }
</script>
{% endblock %}
