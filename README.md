# **Sistema de Control de Acceso por Reconocimiento de Matr√≠culas**

**Autor:** Daniel Serrano Mar√≠n

**I.E.S. Francisco Romero Vargas**
**Administraci√≥n de Sistemas Inform√°ticos en Red**
**Curso: 2024/2025**

## **Resumen**
### **1. Introducci√≥n**

Este documento ofrece una visi√≥n general completa del sistema **Control Acceso Matr√≠culas**, una soluci√≥n de control de acceso de veh√≠culos basada en el reconocimiento autom√°tico de matr√≠culas. El sistema permite una gesti√≥n segura del acceso a instalaciones mediante la captura de im√°genes de matr√≠culas con una Raspberry Pi, su procesamiento usando OpenALPR y la verificaci√≥n de autorizaci√≥n en una base de datos centralizada. Esta p√°gina cubre la arquitectura general, los componentes clave, los flujos de trabajo y c√≥mo interact√∫an dichos componentes.

### **2. Finalidad**

El objetivo principal es mejorar la **automatizaci√≥n del acceso** mediante el reconocimiento de matr√≠culas.

#### **Beneficios del sistema:**

- **Acceso automatizado**, eliminando la necesidad de tarjetas o mandos.

- **Mayor seguridad**, permitiendo solo la entrada de veh√≠culos autorizados.

- **Gesti√≥n eficiente**, con un sistema centralizado para administrar accesos.

- **Registro detallado** de todos los accesos.


### **3. Objetivos**

Desde un punto de vista t√©cnico, el proyecto se centra en:

- **Capturar im√°genes de matr√≠culas** con una **c√°mara en Raspberry Pi 3B**.

- **Detectar matr√≠culas autom√°ticamente** con **OpenALPR**.

- **Almacenar y gestionar matr√≠culas** en una **base de datos MySQL**.

- **Desarrollo un script en Python** que compare matr√≠culas con la base de datos.

- Una **API** con Flask para la gesti√≥n de matr√≠culas.

- **Una interfaz web** para que los usuarios puedan solicitar el registro de su matr√≠cula y otra **interfaz web** para administradores.

- **Implementaci√≥n un panel de administraci√≥n** donde se aprueben o rechacen matr√≠culas.


### **4. Medios Utilizados**

Para llevar a cabo este proyecto, se necesitar√°:

**Hardware:**

- Raspberry Pi 3B con Ubuntu Server.
    
- C√°mara Raspberry Pi HQ.
    
- MicroSD de al menos 16GB con sistema operativo instalado.
    
- VPS en DigitalOcean para alojar la base de datos y la API.
    

**Software:**

- Python, Flask (API), MySQL (base de datos).
    
- OpenALPR para reconocimiento de matr√≠culas.
    
- HTML + Bootstrap + Flask para la interfaz web.
    
- Servidor web.
    

### **5. Estructura del repositorio**

```
/control-acceso-matriculas
‚îú‚îÄ‚îÄ README.md                  # Documentaci√≥n del proyecto
‚îú‚îÄ‚îÄ .gitignore                 # Archivos ignorados por Git
‚îú‚îÄ‚îÄ üìÅ canvas/                    # Diagrama de rutas en Obsidian Canvas
‚îÇ   ‚îî‚îÄ‚îÄ rutasaplicacion.canvas
‚îú‚îÄ‚îÄ üìÅ docs/                     # Documentaci√≥n t√©cnica
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ capturas_documentacion/
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ Raspberry/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EjecucionAutomaticaScript.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ExplicacionProcesarMatricula.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÅ OpenALPR/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ InstalacionOpenALPR.md
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ VPS/
‚îÇ       ‚îî‚îÄ‚îÄ DespliegueAplicacionFlaskconGunicorn.md
‚îú‚îÄ‚îÄ üìÅ backend/                  # Aplicaci√≥n Flask (API y frontend integrado)
‚îÇ   ‚îú‚îÄ‚îÄ app.py
‚îÇ   ‚îú‚îÄ‚îÄ wsgi.py
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ routes/               # Blueprints Flask: auth, api, admin, main, matriculas
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ templates/            # Plantillas HTML
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ static/               # CSS, iconos, im√°genes
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ utils/                # db_utils.py y funciones auxiliares
‚îú‚îÄ‚îÄ üìÅ raspberry-pi/             # Script de captura en Raspberry Pi
‚îÇ   ‚îî‚îÄ‚îÄ procesar_matricula.py
```

## **Arquitectura del Sistema**

El sistema _Control Acceso Matr√≠culas_ consta de tres componentes principales:

- **Aplicaci√≥n Web**: Un servidor basado en Flask que gestiona la autenticaci√≥n de usuarios, la gesti√≥n de matr√≠culas y la l√≥gica de control de acceso.
   
- **Componente Raspberry Pi**: Captura im√°genes, procesa las matr√≠culas y se comunica con el servidor.

- **Interfaz de Usuario**: Interfaces web tanto para usuarios normales como para administradores.

### **1. Arquitectura MVC**

El patr√≥n de dise√±√≥ utilizado en este proyecto es la arquitectura **MVC** (Modelo-Vista-Controlador). La arquitectura **MVC** es un patr√≥n de dise√±o muy com√∫n en el desarrollo de aplicaciones web, incluido. Divide la l√≥gica de una aplicaci√≥n en tres componentes separados:

- **Modelos** 
	
	- ¬øQu√© es?
	
		Representa **los datos** y la l√≥gica de la base de datos de la aplicaci√≥n.

	- En mi proyecto:
	
		- Se gestiona con funciones de acceso a la [base de datos](db_tfg/control_acceso.sql) en [db_utils.py](backend/utils/db_utils.py).
		    
		- Se encarga de:
		    
		    - Conectarse a MySQL.
		        
		    - Recuperar y guardar informaci√≥n sobre usuarios, matr√≠culas, accesos.
		
		**Ejemplo:**
		
		```python
		def conectar_db():
		
		¬† ¬† return mysql.connector.connect(
		¬† ¬† ¬† ¬† host="localhost",
		¬† ¬† ¬† ¬† user="flask_user",
		¬† ¬† ¬† ¬† password="flask_user",
		¬† ¬† ¬† ¬† database="control_acceso"
		¬† ¬† )
		```
		
 		> C√≥digo extra√≠do del archivo: [db_utils.py](backend/utils/db_utils.py#L6-L12).

- **Vistas**

	- ¬øQu√© es?
	
		Es la **interfaz visual** con la que interact√∫a el usuario: HTML, CSS y Flask (Python).
	
	 - En mi proyecto:
	
		- Est√°n en la carpeta [templates](backend/templates/).
		    
		- Se usan con **Jinja2** para insertar din√°micamente datos en las p√°ginas.
		    
		- Muestran matr√≠culas, formularios de login, tablas de usuarios, etc.
		    
	    **Ejemplo:**

		```html
		<h4 class="text-white mb-0">Mis Matr√≠culas Registradas</h4>
		{% for matricula, estado in todas %}
		  <tr>
		    <td>{{ matricula }}</td>
		    <td>{{ estado }}</td>
		  </tr>
		{% endfor %}
		```

 		> C√≥digo extra√≠do del archivo: [index.html](backend/templates/index.html#L80-L109).

- **Controladores**

	- ¬øQu√© es?
	
		Es el **puente entre el Modelo y la Vista**. Gestiona la l√≥gica de la aplicaci√≥n: recibe peticiones del usuario, actualiza modelos y decide qu√© vista mostrar.
	
	-  En mi proyecto:
	
		- Est√°n en [routes/](backend/routes/): [auth.py](backend/routes/auth.py), [main.py](backend/routes/main.py), [admin.py](backend/routes/admin.py), etc.
		    
		- Cada archivo define rutas (`@app.route`) y qu√© hacer cuando se accede a ellas.
			
	    **Ejemplo:**

		```python
		@main.route("/")
		@login_required
		def index():
		    conexion = conectar_db()
		    cursor = conexion.cursor()
		...
		```

		> C√≥digo extra√≠do del archivo: [main.py](backend/routes/main.py#L12-L16).


## **Componentes del Backend**

### **1. Sistema de Autenticaci√≥n**

<details>
<summary>Archivos fuente de esta parte</summary>
<ul>
	<li><a href="backend/routes/auth.py">auth.py</a></li>
</ul>
</details>


#### Resumen del sistema

El sistema de autenticaci√≥n gestiona la verificaci√≥n de identidad de usuarios, mantiene sus sesiones y controla el acceso a las distintas secciones de la aplicaci√≥n seg√∫n el rol del usuario (usuario o administrador).

---

#### Modelo de usuario y almacenamiento de datos

Se utiliza una clase personalizada `User` que implementa `UserMixin` de Flask-Login para representar a los usuarios autenticados. Los datos se almacenan en la tabla `usuarios` de la base de datos MySQL.

##### Atributos del modelo `User`:

- `id`: identificador √∫nico
    
- `nombre`: nombre del usuario
    
- `email`: direcci√≥n de correo (para login)
    
- `password`: contrase√±a (hash)
    
- `matricula`: matr√≠cula asociada (opcional)
    
- `rol`: `admin` o `usuario`
    

Las contrase√±as se almacenan con hash seguro usando `generate_password_hash`, y se verifican con `check_password_hash`.

---

#### Flujo de autenticaci√≥n

**Inicio de sesi√≥n:**

1. El usuario env√≠a email y contrase√±a al endpoint `/login`.
    
2. El sistema consulta el usuario por email.
    
3. Se compara el hash de la contrase√±a.
    
4. Si coincide:
    
    - Se inicia sesi√≥n con `login_user()`.
        
    - Se guarda el rol en la sesi√≥n.
        
    - Se redirige seg√∫n el rol: dashboard o panel admin.
        

**Registro:**

1. El usuario completa el formulario.
    
2. Se valida:
    
    - Coincidencia de contrase√±as.
        
    - Unicidad del email.
        
3. Se guarda el usuario con rol `usuario` y se redirige al login.
    

---

#### Gesti√≥n de sesiones

Usa Flask-Login para:

- Verificar si el usuario est√° autenticado.
    
- Proteger rutas con `@login_required`.
    
- Cerrar sesi√≥n correctamente (`logout_user()`).
    
- Guardar el rol en la sesi√≥n para controlar el acceso.
    

---

### Control de acceso basado en roles

Se definen dos roles:

- `usuario`: permisos limitados.
    
- `admin`: acceso completo.
    

Se usa un decorador `@solo_admin` para:

1. Verificar si el rol en sesi√≥n es `admin`.
    
2. Redirigir con error si no lo es.
    
3. Permitir acceso si lo es.
    

#### Rutas protegidas para admin:

- `/matriculas_admin`
    
- `/admin/editar_matricula`
    
- `/admin/eliminar_matricula/<id>`
    

---

### Integraci√≥n en la interfaz

#### Navegaci√≥n condicional

La barra de navegaci√≥n muestra enlaces distintos seg√∫n el rol y estado de autenticaci√≥n.

#### Formularios

- **Login**: solicita email y contrase√±a.
    
- **Registro**: incluye nombre, email, contrase√±a y confirmaci√≥n.
    

---

### Funciones de administraci√≥n

#### Crear usuarios

El administrador puede crear nuevos usuarios desde el panel.

#### Editar usuarios

Puede cambiar nombre, apellidos y email, verificando que no est√© duplicado.

---

### Seguridad

1. **Contrase√±as**:
    
    - Hash seguro (Werkzeug).
        
    - Validaci√≥n en login y registro.
        
2. **Validaciones**:
    
    - Emails √∫nicos.
        
    - Confirmaci√≥n de contrase√±a.
        
3. **Sesiones**:
    
    - Se borra todo en logout.
        
    - Decoradores protegen rutas sensibles.

---
### **2. Componente Raspberry Pi**

Es el **sensor inteligente del sistema**. Se encarga de capturar la matr√≠cula de un veh√≠culo en tiempo real y comunicarse con el servidor para validar el acceso.
#### 1. Funcionamiento paso a paso

- La Raspberry Pi utiliza una [c√°mara](https://www.amazon.es/dp/B081Q8ZT9J) conectada f√≠sicamente.
    
- El script [procesar_matricula.py](raspberry-pi/procesar_matricula.py) ejecuta continuamente este comando:

```python
fswebcam -r 1280x720 --no-banner {CAPTURA}
```

> C√≥digo extra√≠do del archivo: [procesar_matricula.py](raspberry-pi/procesar_matricula.py#L12).

Y con ese comando, se guarda una imagen de la matricula que est√° frente a la c√°mara.

#### 2. Reconocimiento de matr√≠cula

- Se analiza la imagen usando **OpenALPR**, un sistema de reconocimiento autom√°tico de matr√≠culas.

```python
resultado = subprocess.run(["alpr", "-c", "eu", imagen], capture_output=True, text=True)
```

> C√≥digo extra√≠do del archivo: [procesar_matricula.py](raspberry-pi/procesar_matricula.py#L16).

OpenALPR detecta si hay una matr√≠cula en la imagen y extrae el texto, por ejemplo `1234ABC`.

#### 3. Comunicaci√≥n con el servidor

- Si se detecta una matr√≠cula v√°lida, la Raspberry Pi **env√≠a la matr√≠cula y la imagen** al servidor web (Flask) mediante una petici√≥n **HTTP POST**:

```python
SERVIDOR="https://matriculas.dsermar0808.tech/recibir_matricula"
...
respuesta = requests.post(SERVIDOR, files=archivos, data=datos, timeout=5)
```

> C√≥digo extra√≠do del archivo: [procesar_matricula.py](raspberry-pi/procesar_matricula.py#L27).

El servidor se encarga de comprobar si esa matr√≠cula est√° autorizada o no.

#### 4. Repetici√≥n autom√°tica

- Este proceso se ejecuta [cada segundo](raspberry-pi/procesar_matricula.py#L53) en un bucle infinito.

- Tambi√©n se evita repetir matr√≠culas si son consecutivas.

```python
if matricula_detectada:

	print(f"üöó Matr√≠cula detectada: {matricula_detectada}")

	if matricula_detectada != ultima_matricula:
		enviar_matricula(matricula_detectada, imagen)
		ultima_matricula = matricula_detectada
	else:

		print("‚è© Matr√≠cula repetida, no se env√≠a de nuevo.")

	
else:
	print("‚ö†Ô∏è No se detect√≥ ninguna matr√≠cula.")
	ultima_matricula = None
```

> C√≥digo extra√≠do del archivo: [procesar_matricula.py](raspberry-pi/procesar_matricula.py#L42-L51).

#### 5. ¬øC√≥mo se ejecuta autom√°ticamente?

Se configura como **servicio `systemd`**, es decir, se inicia solo cuando se enciende la Raspberry.

Este es el archivo de configuraci√≥n [matricula.service](systemd/matricula.service).

```service
[Unit]
Description=Script de detecci√≥n de matr√≠culas
After=network.target

[Service]
ExecStart=/usr/bin/python3 /home/dsermar/control-acceso-matriculas/raspberry-pi/procesar_matricula.py
WorkingDirectory=/home/dsermar/control-acceso-matriculas/raspberry-pi
StandardOutput=append:/var/log/matricula.log
StandardError=append:/var/log/matricula.log
Restart=always
User=dsermar

[Install]
WantedBy=multi-user.target
```

#### 6. Ventajas de este dise√±o

- **Descentralizado**: la Raspberry Pi toma decisiones r√°pidamente sin depender de c√°maras IP complejas.
    
- **Flexible**: puedes cambiar la l√≥gica del servidor sin tocar el script.
    
- **Escalable**: puedes a√±adir m√°s Raspberrys en otras entradas f√°cilmente.

### **3. Interfaz web**

La interfaz de usuario est√° desarrollada con HTML, CSS (combin√°ndolo con Bootstrap tambi√©n), y el motor de plantillas Jinja2 integrado en Flask. Su dise√±o adapta din√°micamente los elementos mostrados seg√∫n el rol del usuario: `admin` o `usuario`.

**Para usuarios normales:**

- P√°gina principal ([/](backend/routes/main.py#L12-L71)) que muestra un resumen de sus matr√≠culas registradas, divididas por estado ([autorizadas](backend/routes/main.py#L26-L32), [pendientes](backend/routes/main.py#L42-L48), [denegadas](backend/routes/main.py#L34-L40)).

	![tabla de matriculas registradas](capturas/matriculas_registradas.png)

- Un gr√°fico con sus accesos diarios, generado con **Chart.js**.

	![gr√°fico entradas por dia](capturas/graficaentradas.png)

	- C√≥digo del gr√°fico:
	
	```html
	<script>
	const ctxEntradas = document.getElementById('graficoEntradas').getContext('2d');
	
	new Chart(ctxEntradas, {
	
	¬† type: 'line',
	¬† data: {
	¬† ¬† labels: {{ fechas|tojson }},
	
	¬† ¬† datasets: [{
	¬† ¬† ¬† label: 'Entradas por D√≠a',
	¬† ¬† ¬† data: {{ cantidades|tojson }},
	¬† ¬† ¬† fill: true,
	¬† ¬† ¬† backgroundColor: 'rgba(20, 179, 242, 0.15)',
	¬† ¬† ¬† borderColor: '#14b3f2',
	¬† ¬† ¬† tension: 0.4
	¬† ¬† }]
	
	¬† },
	
	¬† options: {
	¬† ¬† responsive: true,
	
	¬† ¬† plugins: {
	¬† ¬† ¬† legend: { labels: { color: 'white' } },
	¬† ¬† ¬† title: { display: false }
	¬† ¬† },
	
	¬† scales: {
	¬† ¬† x: { ticks: { color: '#fff' } },
	
	¬† ¬† y: {
	¬† ¬† ¬† beginAtZero: true,
	
	¬† ¬† ¬† ticks: {
	¬† ¬† ¬† ¬† color: '#fff',
	¬† ¬† ¬† ¬† stepSize: 1,
	¬† ¬† ¬† ¬† callback: function(value) {
	¬† ¬† ¬† ¬† ¬† return Number.isInteger(value) ? value : null;
	¬† ¬† ¬† ¬† }
	¬† ¬† ¬† }
	¬† ¬† }
	¬† }
	¬† }
	});
	</script>
	```
	
	> C√≥digo extra√≠do del archivo: [index.html](backend/templates/index.html#L215-L251).


- Formulario para solicitar nuevas matr√≠culas.

	![solicitar matricula](capturas/solicitar_matricula.png)

	- C√≥digo del backend para solicitar matricula:

	```python
	@matriculas.route('/solicitar_matricula', methods=['GET', 'POST'])
	@login_required
	def solicitar_matricula():
		...
	```
	> C√≥digo extra√≠do del archivo: [matriculas.py](backend/routes/matriculas.py#L21-L78).

- [P√°gina de historial](backend/templates/historial.html) con filtros de fechas y visualizaci√≥n de im√°genes asociadas a cada acceso.

	![historial](capturas/historial.png)
	

**Para administradores:**

- Acceso a [/admin](backend/routes/admin.py) con un panel que muestra todos los usuarios registrados y todas las matr√≠culas del sistema.

	 ![panel de administraci√≥n](capturas/admin_panel.png)

	![Todas las matr√≠culas](capturas/matriculas_admin.png)


- Tabla de matr√≠culas pendientes con botones para aprobar o rechazar solicitudes.

	![matriculas pendientes](capturas/matriculas_pendientes.png)


- Vistas filtradas y editables de matr√≠culas existentes.
- Modales para crear [nuevos usuarios](backend/templates/admin_panel.html#L100-L131) y [editar usuarios existentes](backend/templates/admin_panel.html#L133-L171).
- Botones de acci√≥n r√°pida para [gestionar roles](backend/routes/admin.py#L20-L39), [limpiar historial](backend/routes/admin.py#L175-L189), o [eliminar registros](backend/routes/admin.py#L114-L125).





